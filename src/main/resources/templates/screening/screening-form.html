<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Add Screening</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h1 class="mb-4">Add New Screening</h1>

            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error!</strong> <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <form th:action="@{/screenings/admin/add}" th:object="${screening}" method="post">
                <div class="mb-3">
                    <label for="movie" class="form-label">Movie</label>
                    <select class="form-select" id="movie" th:field="*{movieId}" required>
                        <option value="">Select a movie</option>
                        <option th:each="movie : ${movies}" th:value="${movie.id}" th:text="${movie.title}"></option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="room" class="form-label">Room</label>
                    <select class="form-select" id="room" th:field="*{roomId}" required>
                        <option value="">Select a room</option>
                        <option th:each="room : ${rooms}" th:value="${room.id}" th:text="${room.name}"></option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="screeningTime" class="form-label">Screening Date and Time</label>
                    <input type="datetime-local" class="form-control" id="screeningTime" th:field="*{screeningTime}" required>
                </div>


                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">Add Screening</button>
                    <a href="/screenings" class="btn btn-secondary">Cancel</a>
                </div>

                <div th:if="${showConflictButton}" class="mt-3 alert alert-warning">
                    <p>This screening conflicts with another. Would you like to see the list?</p>
                    <button type="button" class="btn btn-warning" id="checkConflictsBtn">Check List</button>
                    <div id="conflictsList" class="mt-3" style="display:none;">
                        <h6>Conflicts:</h6>
                        <ul id="conflictsUl" class="list-group"></ul>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('checkConflictsBtn').addEventListener('click', function() {
        const roomId = document.getElementById('room').value;
        const movieId = document.getElementById('movie').value;
        const screeningTime = document.getElementById('screeningTime').value;

        // Convert datetime-local format to ISO string
        const startTime = new Date(screeningTime).toISOString();

        fetch(`/api/v1/screenings/collisions?movieId=${movieId}&roomId=${roomId}&startTime=${startTime}`)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('conflictsUl');
                list.innerHTML = '';

                if (data.length === 0) {
                    list.innerHTML = '<li class="list-group-item">No conflicts</li>';
                } else {
                    data.forEach(screening => {
                        const item = document.createElement('li');
                        item.className = 'list-group-item';
                        item.textContent = `Movie: ${screening.movieTitle} \n Room: ${screening.roomName} \nTime: ${new Date(screening.screeningTime).toLocaleString('en-US')}-${new Date(screening.endTime).toLocaleString('en-US')}`;
                        list.appendChild(item);
                    });
                }

                document.getElementById('conflictsList').style.display = 'block';
            })
            .catch(error => console.error('Error:', error));
    });
</script>

</body>
</html>