

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <title>Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
    .cinema-room {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 10px;
        max-width: 600px;
        margin: 0 auto;
    }
    .seat {
        width: 40px;
        height: 40px;
        background-color: #28a745;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        line-height: 40px;
        color: white;
    }
    .seat.taken {
        background-color: #dc3545;
        cursor: not-allowed;
    }
    .seat.selected {
        background-color: #ffc107;
    }
</style>
<body class="bg-light">
<h2>Choose seats</h2>
<h1 th:text="${#authentication.principal.id}"></h1>
<div class="cinema-room">
    <div th:each="seat : ${seats}"
         th:classappend="${!seat.isAvailable && seat.userId == #authentication.principal.id} ? 'selected' : (!seat.isAvailable ? 'taken' : '')"
         class="seat"
         th:data-id="${seat.seatId}"
         th:onclick="${seat.isAvailable || (!seat.isAvailable && seat.userId == #authentication.principal.id)} ? 'toggleSeat(this)' : ''">

        <span th:text="${seat.seatNumber}">1</span>
    </div>
</div>

<a href="/#" class="btn btn-primary mt-4">Next</a>

<script>
    async function toggleSeat(element) {
        const seatId = element.getAttribute('data-id');
        const screeningId = [[${screeningId}]];

        if (element.classList.contains('selected')) {
            const response = await fetch('/api/v1/reservations/lock', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seatId: seatId, screeningId: screeningId })
            });
            if (response.ok) {
                element.classList.remove('selected');
                return;
            } else {
                alert('Someone else just took this seat!');
                location.reload();
                return;
            }
        }

        try {
            const response = await fetch('/api/v1/reservations/lock', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seatId: seatId, screeningId: screeningId })
            });

            if (response.ok) {
                element.classList.add('selected');
            } else {
                alert('Someone else just took this seat!');
                location.reload();
            }
        } catch (e) {
            console.error(e);
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>